# Архитектура и решения

## Стек и структура
- Монорепозиторий на npm workspaces: `packages/client` (React + TypeScript + Vite) и `packages/server` (Express + TypeScript).
- Node.js 20.19, общий ESLint/TSConfig на корне. Сервер после сборки раздаёт статический фронтенд из `dist/public` и обслуживает API.
- dev-режим: Vite (порт 5173) проксирует `/api` на Express (порт 3000).

## API и Telegram
- `POST /api/game/result { result: "win" | "loss" | "draw" }` → `{ promoCode?: string | null }`. Валидация через zod, ошибки → `400`.
- Отправка в Telegram через Bot API (`fetch` + `AbortController`, таймаут по умолчанию 5 c). При отсутствии `TELEGRAM_BOT_TOKEN`/`TELEGRAM_CHAT_ID` запросы пропускаются с предупреждением, сервер не падает.
- Уведомления о ничьей по умолчанию отключены; можно включить переменной `TELEGRAM_NOTIFY_ON_DRAW=true` (решение принято, чтобы не шуметь чат лишними событиями).
- Поддержка нескольких пользователей без БД: фоновый бот опрашивает `getUpdates` и отвечает на /start персональной ссылкой `GAME_LINK?chatId=<id>`. Клиент добавляет `chatId` к запросу `POST /api/game/result`, поэтому уведомления прилетают в тот Telegram-чат, откуда открыли ссылку (fallback — `TELEGRAM_CHAT_ID` в .env).

## Промокоды
- Генерация на сервере: `Math.random()` → число 0–99999 с `padStart(5, "0")`, чтобы исключить подмену на клиенте.
- Клиент при победе показывает код из API; если сеть недоступна, выводит резервный 5-значный код с предупреждением (чтобы не ломать UX тестового сценария).

## Логика игры
- Игрок всегда крестики (X), компьютер — нолики (O). Проверка победных линий в `game/logic.ts`.
- ИИ использует minimax (оценка: победа ИИ = 10 - глубина, победа игрока = глубина - 10, ничья = 0) и выбирает ход с максимальным счётом. Задержка перед ходом ~380 мс для плавности.
- После окончания партии клики блокируются; отображается CTA «Сыграть ещё раз», индикатор текущего хода и контекстные подсказки.

## Тесты
- Vitest для фронта (игровая логика и minimax), Vitest + Supertest для бэкенда (валидация API, промокоды, моки Telegram).
- В тестах Telegram-запросы мокируются, чтобы не ходить в сеть.

## Сборка и деплой
- `npm run build`: Vite собирает фронт, затем `tsc` компилирует сервер и копирует фронт в `dist/public`.
- Dockerfile — multi-stage (Node 20 alpine), после сборки выполняется `npm prune --omit=dev`; docker-compose публикует порт 80 → 3000.
- GitHub Actions: `ci.yml` (install → lint → test → build) и `deploy.yml` (push в `main` → SSH на сервер, `git pull`, `docker compose up -d --build`).

## Компромиссы и дальнейшие шаги
- Нет постоянного хранилища и авторизации — для тестового задания достаточно; в проде стоит добавить rate limiting, логирование в внешнее хранилище и менеджер секретов.
- Резервный промокод на клиенте улучшает UX, но в бою лучше возвращать ошибку и ретраи.
- Можно добавить анимацию хода ИИ и метрики (Яндекс.Метрика/GA) после согласования.

## Метаданные
- Автор: Yan Bubenok (yan@bubenok.com, Telegram: @iBubenok, GitHub: @iBubenok).
- Имя локальной папки и репозитория: `xo-telegram-promo`.
- Первый коммит: «Добавить игру крестики-нолики с уведомлениями в Telegram».
