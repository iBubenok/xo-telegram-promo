# Крестики-нолики с промокодами и Telegram

Тестовый проект: игра «Крестики-нолики» против компьютера. Победа выдаёт 5-значный промокод (отправляется в Telegram), проигрыш отправляет уведомление «Проигрыш», ничья показывается корректно. Дизайн мягкий, адаптированный под аудиторию 25–40.

- Демо: **[добавить ссылку перед отправкой работодателю]**
- Стек: React + TypeScript (Vite), Express + TypeScript, Node.js 20.19, Docker.
- Автор: Yan Bubenok (yan@bubenok.com, Telegram: @iBubenok, GitHub: @iBubenok)

## Возможности
- Игрок (X) против компьютера (O) на minimax: боты блокируют ошибки и играют уверенно.
- Победа → сервер генерирует 5-значный промокод, показывает его на экране и шлёт «Победа! Промокод выдан: [код]» в Telegram.
- Проигрыш → Telegram «Проигрыш» и CTA «Сыграть ещё раз».
- Ничья → сообщение «Ничья» + CTA; уведомление в Telegram опционально (`TELEGRAM_NOTIFY_ON_DRAW`).
- Блокировка кликов после конца игры, индикатор хода, плавные анимации, мобильная вёрстка.
- Мульти-чат без БД: бот отвечает на /start с ссылкой `GAME_LINK?chatId=<id>`. Открыв игру по этой ссылке, пользователь получает уведомления именно в свой чат.
- Две сложности ИИ: «Уверенная» (minimax) и «Лёгкая» (случайные ходы, можно выиграть для демонстрации промокода).

## Быстрый старт локально
Требования: Node.js ≥ 20.19, npm 10.

```bash
cd github
cp .env.example .env    # заполните TELEGRAM_BOT_TOKEN и TELEGRAM_CHAT_ID при наличии
npm install

# dev-режим (два терминала)
npm run dev:server
npm run dev:client      # http://localhost:5173, API проксировано на 3000

# или production-режим локально
npm run build
npm start               # http://localhost:3000 (раздаёт собранный фронт + API)
```

## Запуск через Docker
```bash
cd github
cp .env.example .env    # заполните переменные
HOST_PORT=8080 docker compose up -d --build  # HOST_PORT можно опустить, по умолчанию 80
# приложение будет доступно на http://localhost:8080 (или http://localhost при HOST_PORT=80)
```

## Переменные окружения
- `PORT` — порт сервера (по умолчанию 3000).
- `TELEGRAM_BOT_TOKEN` — токен бота.
- `TELEGRAM_CHAT_ID` — чат/канал для уведомлений.
- `GAME_LINK` — ссылка на игру (для бота; использует `?chatId=<id>`).
- `TELEGRAM_TIMEOUT_MS` — таймаут запроса в Telegram (по умолчанию 5000).
- `TELEGRAM_NOTIFY_ON_DRAW` — отправлять ли уведомления при ничьей (`false` по умолчанию).
- `HOST_PORT` — внешний порт Docker (если нужно отличать от 80).
- `VITE_API_URL` — базовый URL API для фронтенда (обычно пусто для относительных запросов).

## Скрипты
- `npm run dev:client` / `npm run dev:server` — отдельные дев-сервера.
- `npm run lint` — ESLint.
- `npm run test` — Vitest (логика игры и API, Telegram мокируется).
- `npm run build` — сборка фронта и бэка, копирование статики.
- `npm start` — запуск собранного сервера.

## CI/CD
- `.github/workflows/ci.yml` — `npm ci` → `lint` → `test` → `build` на push/PR.
- `.github/workflows/deploy.yml` — деплой при push в `main`: SSH на сервер, `git pull`, `docker compose up -d --build`.

### Секреты GitHub Actions для автодеплоя
- `SSH_HOST` — адрес сервера.
- `SSH_USER` — пользователь для SSH (например, `root` или деплой-пользователь).
- `SSH_KEY` — приватный ключ (ed25519/RSA) для доступа к серверу.
- `APP_DIR` — каталог на сервере (например, `/opt/xo-telegram-promo`).
- Токены `TELEGRAM_BOT_TOKEN`/`TELEGRAM_CHAT_ID` хранятся в `.env` на сервере; при желании их можно держать в Secrets и использовать при генерации файла окружения.

## Ручной деплой на сервер
1. Установить Docker и docker compose plugin.
2. Создать каталог, клонировать репозиторий: `git clone git@github.com:iBubenok/xo-telegram-promo.git /opt/xo-telegram-promo`.
3. Создать `/opt/xo-telegram-promo/.env` по образцу `.env.example`.
4. Запустить: `docker compose up -d --build` (порт 80 → 3000).
5. Проверить, что бот отвечает, а фронт открывается по IP сервера без указания порта.
6. Для проверки уведомлений из своего Telegram: написать боту /start и открыть ссылку из ответа, чтобы `chatId` подставился в игру.

## Быстрая проверка (2–3 минуты)
- Запустить проект (Docker или `npm start` после сборки) и открыть в браузере.
- Написать боту /start — он пришлёт ссылку вида `GAME_LINK?chatId=<id>`; открыть её.
- Выиграть партию: увидеть 5-значный промокод на экране и сообщение «Победа! Промокод выдан: [код]» в Telegram.
- Проиграть партию: получить «Проигрыш» в Telegram и CTA «Сыграть ещё раз».
- Довести до ничьей: увидеть статус «Ничья» + кнопку рестарта (уведомление в Telegram по желанию).
- Отключить переменные Telegram и убедиться, что игра работает без падений (сервер только логирует предупреждение).
- Прогнать `npm run test` и `npm run build` — оба проходят.
